name: Notify Discord on Changelog Update

on:
  push:
    branches:
      - main

jobs:
  notify-discord:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for changed files
        id: changed-files
        run: |
          git diff --name-only HEAD^ HEAD > changed_files.txt
          echo "CHANGED_FILES=$(cat changed_files.txt)" >> $GITHUB_ENV
          echo "Změněné soubory: $CHANGED_FILES"

      - name: DC sender
        if: contains(env.CHANGED_FILES, 'changelog.json')
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ ! -f changelog.json ]; then
            echo "Soubor changelog.json nebyl nalezen!"
            exit 1
          fi
          COMMIT_AUTHOR=$(git log -1 --pretty=%an | sed 's/"/\\"/g')
          VERSION=$(jq -r '.[keys[-1]].Version // "Není dostupné"' changelog.json 2>/dev/null || echo "Není dostupné")
          TITLE=$(jq -r '.[keys[-1]].Title // "Není dostupné"' changelog.json 2>/dev/null || echo "Není dostupné")
          DATE=$(jq -r '.[keys[-1]].Date // "Není dostupné"' changelog.json 2>/dev/null || echo "Není dostupné")
          CONTENT=$(jq -r '.[keys[-1]].Content[] // empty' changelog.json 2>/dev/null | paste -sd '\n' || echo "Žádný obsah")
          echo "Extrahovaný Content: $CONTENT"
          
          # Přesný timestamp v UTC (sekundy od epochy)
          TIMESTAMP=$(date -u +%s)
          CONTEXT="Odesláno od $COMMIT_AUTHOR, <t:$TIMESTAMP>"
          
          # Vytvoření JSON pro Discord Embed
          EMBED_JSON=$(jq -n \
            --arg content "$CONTEXT" \
            --arg title "$TITLE" \
            --arg desc "$CONTENT" \
            --arg version "$VERSION" \
            --arg date "$DATE" \
            '{
              content: $content,
              embeds: [{
                title: $title,
                description: $desc,
                color: 4618276,  -- Střední modrá (#4682B4)
                footer: { text: "Verze: \($version) | Datum: \($date)" }
              }]
            }')
          
          echo "Zpráva pro Discord (JSON): $EMBED_JSON"
          curl -H "Content-Type: application/json" -X POST -d "$EMBED_JSON" "$DISCORD_WEBHOOK" || echo "Chyba při odesílání na Discord: $?"
