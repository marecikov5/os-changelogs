name: OS Changelogs

on:
  push:
    branches:
      - main

jobs:
  notify-discord:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for changed files
        id: changed-files
        run: |
          git diff --name-only HEAD^ HEAD > changed_files.txt
          echo "CHANGED_FILES=$(cat changed_files.txt)" >> $GITHUB_ENV
          echo "Changed files: $CHANGED_FILES"

      - name: DC sender
        if: contains(env.CHANGED_FILES, 'changelog.json')
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ ! -f changelog.json ]; then
            echo "File changelog.json was not found!"
            exit 1
          fi
          COMMIT_AUTHOR=$(git log -1 --pretty=%an | sed 's/"/\\"/g')
          VERSION=$(jq -r '.[keys[-1]].Version // "N/A"' changelog.json 2>/dev/null || echo "N/A")
          TITLE=$(jq -r '.[keys[-1]].Title // "N/A"' changelog.json 2>/dev/null || echo "N/A")
          DATE=$(jq -r '.[keys[-1]].Date // "N/A"' changelog.json 2>/dev/null || echo "N/A")
          CONTENT=$(jq -r '.[keys[-1]].Content[] // empty' changelog.json 2>/dev/null | paste -sd '\n' || echo "Not found")
          echo "Extrahovan√Ω Content: $CONTENT"
          
          TIMESTAMP=$(date -u +%s)
          CONTEXT="-# [üí•] Author: $COMMIT_AUTHOR\\n -# [üóìÔ∏è] Full date: <t:$TIMESTAMP>"
          FULL_MESSAGE="$CONTEXT\\n**Game Link**: [JOIN TODAY](https://roblox.com)"
          
          EMBED_JSON=$(jq -n \
            --arg content "$FULL_MESSAGE" \
            --arg title "$TITLE" \
            --arg desc "$CONTENT" \
            --arg version "$VERSION" \
            --arg date "$DATE" \
            '{
              content: $content,
              embeds: [{
                title: $title,
                description: $desc,
                color: 4618276,
                footer: { text: "Version: \($version) | Date: \($date)" }
              }]
            }')
          
          echo "Message for DC (JSON): $EMBED_JSON"
          curl -H "Content-Type: application/json" -X POST -d "$EMBED_JSON" "$DISCORD_WEBHOOK" || echo "Chyba p≈ôi odes√≠l√°n√≠ na Discord: $?"
