name: Webhook notification

on:
  push:
    branches:
      - main

jobs:
  notify-discord:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for changed files
        id: changed-files
        run: |
          git diff --name-only HEAD^ HEAD > changed_files.txt
          echo "CHANGED_FILES=$(cat changed_files.txt)" >> $GITHUB_ENV
          echo "Změněné soubory: $CHANGED_FILES"

      - name: DC sender
        if: contains(env.CHANGED_FILES, 'changelog.json')
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          COMMIT_MESSAGE=$(git log -1 --pretty=%s | sed 's/"/\\"/g')
          COMMIT_AUTHOR=$(git log -1 --pretty=%an | sed 's/"/\\"/g')
          COMMIT_URL=$(git log -1 --pretty=%H | xargs -I {} echo "https://github.com/${{ github.repository }}/commit/{}")
          VERSION=$(jq -r '.[keys[-1]].Version // "Není dostupné"' changelog.json)
          TITLE=$(jq -r '.[keys[-1]].Title // "Není dostupné"' changelog.json)
          DATE=$(jq -r '.[keys[-1]].Date // "Není dostupné"' changelog.json)
          CONTENT=$(jq -r '.[keys[-1]].Content | join("\n") // "Žádný obsah"' changelog.json | sed 's/"/\\"/g')
          MESSAGE="**Nový commit v repozitáři!**\n"
          MESSAGE+="**Autor:** ${COMMIT_AUTHOR}\n"
          MESSAGE+="**Zpráva:** ${COMMIT_MESSAGE}\n"
          MESSAGE+="**Odkaz:** ${COMMIT_URL}\n"
          MESSAGE+="\n**Changelog (${VERSION} - ${DATE}):**\n${TITLE}\n${CONTENT}\n"
          echo "Zpráva pro Discord: $MESSAGE"
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"$MESSAGE\"}" \
               "$DISCORD_WEBHOOK" || echo "Chyba při odesílání na Discord: $?"
