name: Notify Discord on Changelog Update

on:
  push:
    branches:
      - main

jobs:
  notify-discord:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          
      - name: Check for changed files
        id: changed-files
        run: |
          git diff --name-only HEAD^ HEAD > changed_files.txt
          echo "CHANGED_FILES=$(cat changed_files.txt)" >> $GITHUB_ENV

      - name: DC sender
        if: contains(env.CHANGED_FILES, 'changelog.json')
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          COMMIT_MESSAGE=$(git log -1 --pretty=%s)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_URL=$(git log -1 --pretty=%H | xargs -I {} echo "https://github.com/${{ github.repository }}/commit/{}")
          
          VERSION=$(jq -r '.[keys[-1]].Version' changelog.json)
          TITLE=$(jq -r '.[keys[-1]].Title' changelog.json)
          DATE=$(jq -r '.[keys[-1]].Date' changelog.json)
          CONTENT=$(jq -r '.[keys[-1]].Content | join("\n")' changelog.json)
          
          MESSAGE+="**Autor:** ${COMMIT_AUTHOR}\n"
          MESSAGE+="**Zpr√°va:** ${COMMIT_MESSAGE}\n"
          MESSAGE+="**Odkaz:** ${COMMIT_URL}\n"
          MESSAGE+="\n**Changelog (${VERSION} - ${DATE}):**\n${TITLE}\n${CONTENT}\n"
          
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"$MESSAGE\"}" \
               $DISCORD_WEBHOOK
